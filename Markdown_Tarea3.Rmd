---
title: "Tarea3"
author: "Luis Hernández"
date: "2025-03-31"
output: html_document
---

## Preparación del entorno (Primera Parte)

### Cargar un objeto phyloseq

Primero cargamos los paquetes correspondientes y corremos el código para observar lo que nos arroja.

```{r cargar_datos}
# Cargar el paquete microbiome 
library(microbiome)

data("dietswap", package = "microbiome")
ps <- dietswap

# Inspeccionar el objeto
ps
# Número de muestras
nsamples(ps)  

# Número de taxones
ntaxa(ps)    
# Variables en los metadatos
sample_variables(ps)
```

-   ¿Cuántas muestras y taxones tiene el objeto? Tiene 222 muestras y 130 taxones

-   ¿Qué variables están disponibles en los metadatos de la muestra? Usamos la función sample_variables(ps) y nos arroja 8 variables de metadatos para la muestra.

### Curvas de rarefacción

Ahora generamos una curva de rarefacción para observar si las muestras están bien analizadas usando la función rarecurve() de vegan sobre la matriz de abundancia.

```{r curva_rarefaccion}
#Extraemos la matriz del OTUs
otu_mat <- as(otu_table(ps), "matrix")
if (!taxa_are_rows(ps)) otu_mat <- t(otu_mat)  # Asegurar que taxones sean filas

# Generar curvas de rarefacción
rarecurve(otu_mat, step = 50, label = FALSE, col = "blue", ylab = "Especies", xlab ="Número de lecturas")
```

-   ¿Qué indican estas curvas?
-   ¿Hay muestras que deberían descartarse por bajo conteo?

### Diversidad alfa

Ahora calculamos y generamos los índices alfa que son el de Riqueza, Shannon y Simpson usando boxplots y utilizando la función plot_richness.

```{r indice_alfa}
# Calcular y graficar índices alfa (Este es de los grupos)
plot_richness(ps, x = "group", measures = c("Observed", "Shannon", "Simpson")) + geom_boxplot(aes(fill = group)) + theme_bw()     
```

-   ¿Qué interpretas de estas gráficas? La primer gráfica nos está indicando las especies observdas en los tres grupos que son DI, ED y HE, por lo que se puede ver que hay una diferencia significativa
-   Hay diferencias notorias entre grupos? Si, el

### Filtrado y transformación

Ahora vamos a filtrar nuestros datos ps para quedarnos con los que tienen .1% de abundancia relativa en el 10% de nuestras muestras

```{r filtrado_transformación}
ps_relativa <- transform_sample_counts(ps, function(x) x / sum(x) * 100)  # Abundancia relativa %

taxa_abundantes <- genefilter_sample(ps_relativa, filterfun_sample(function(x) x >= 0.1), A = 0.1 * nsamples(ps_relativa))  
ps_filtrado <- prune_taxa(taxa_abundantes, ps) 
```

### Diversidad Beta

Se hizo un código de ordención PCoA utilizando distancia de bray-curtis que va a representar la similitud o disimilitud basada en nuestra matriz de distancia.

```{r diversidad_beta}
# Calcular distancia Bray-Curtis
dist_bray <- phyloseq::distance(ps_filtrado, method = "bray")

# Realizar PCoA (Ordination)
pcoa <- ordinate(ps_filtrado, method = "PCoA", distance = dist_bray)

# Graficar PCoA
plot_ordination(ps_filtrado, ordinate(ps_filtrado, "PCoA", distance = "bray"), color = "group", title = "PCoA (Bray-Curtis)") + geom_point(size = 3) + stat_ellipse(level = 0.95) + theme_minimal()
```

-   ¿Los grupos se separan visiblemente? Si, hay una separación de los grupos pero también se observa los puntos con cierta superposición y que la mayoría de variabilidad está a lo largo del eje 1 que explica la diferencia más significativa entre los grupos.
-   ¿Qué podría estar causando estas diferencias? Puede ser por la composición bacteriana estén influenciadas por hábitos alimenticios de los grupos y como filtramos las muestras sólamente estamos viendo los taxa más relevantes.

### Gráficas Rank-Abundance

Observamos la dominancia de los taxones por el género presente, donde observamos los 10 más abundantes.

```{r rank_abundance}
#Gráficas Rank Abundance
otu_df <- as.data.frame(t(otu_table(ps_relativa)))  # Transponer para taxones en columnas
colnames(otu_df) <- tax_table(ps_relativa)[, "Genus"]  # Asignar nombres de géneros

#Calcular abundancias promedio por taxón
taxa_avg <- sort(colMeans(otu_df), decreasing = TRUE)
rank_df <- data.frame(
  Rank = seq_along(taxa_avg),
  Taxon = names(taxa_avg),
  Abundance = taxa_avg
)

head(rank_df, 10) # Estos son los géneros más abundantes
#Gráfica
ggplot(rank_df, aes(x = Rank, y = Abundance)) + geom_point(size = 3) + geom_line() + scale_y_log10() + labs(title = "Curva de Abundancia-Rango", x = "Rango", y = "Abundancia relativa (log10)") + theme_minimal()
```

-   ¿Qué tan dominada está la comunidad por pocos taxones y cuáles son? Los que más aparecen es Prevotella, Clostridium, Fascalibacteria y Sporobacter. Los dos primeros son los más recurrentes por lo que sugiere que pocos taxones dominan esa comunidad.

-   ¿Qué tipo de distribución parece seguir? Es geométrica ya que hay una dominancia alta ehtre dos taxas y los demás aparecen una sola vez, esto es típico ya que hay pocos taxones abundadntes y muchos raros en estas comunidades.

### Gráficas apiladas de abundancia por taxón

Se agruparon en gráficas de barra para observar la abundancia de estas y compararla en cada una de las muestras y observar su abundancia de cada una tanto en género como Phylum

```{r grafica_portaxon}
#Gráfica por Phylum
plot_bar(ps_filtrado, fill = "Phylum") +
  geom_bar(stat = "identity") +
  labs(title = "Composición por Phylum", 
       x = "Muestras", 
       y = "Abundancia relativa") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

#Gráfica por Género 
plot_bar(ps_filtrado, fill = "Genus") +
  geom_bar(stat = "identity") +
  labs(title = "Composición por Género", 
       x = "Muestras", 
       y = "Abundancia relativa") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

-  ¿Hay algún Phylum que domine? Si, el que más domina es 
### Exportación de resultados

## Global Patterns (Segunda Parte)

### Preprocesamiento

### Diversidad Alfa

### Curvas de Rango-Abundancia

### Perfil taxonómico

###Diversidad Beta

## Preguntas de interpretación

-   ¿Qué ambiente muestra mayor diversidad alfa?

-   ¿A qué factores podría deberse?

-   ¿Qué se observa en la ordenación PCoA respecto a similitudes entre muestras?

-   ¿Qué patrón de dominancia taxonómica muestran las curvas de rango-abundancia?

-   ¿Qué phyla son dominantes en cada ambiente y qué implicaciones ecológicas sugieren?
